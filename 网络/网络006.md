## 网络层

ip数据包有head 和 data

### ip数据包格式

这里以ipv4为例

![1561612019453](../image/1561612019453.png)

ipv4数据包有多个区域，类似于帧。

有来源source  address 目的 destination 地址. ipv4地址是4byte=32bit. 通常表现形式是4个10进制的数组成，每个数的范围是0-255. ip包头的 ip地址是此地址的二进制表现形式

IP分类

| IP  class | From      | To              | Subnet mask   |
| --------- | --------- | --------------- | ------------- |
| A         | 1.0.0.0   | 126.255.255.255 | 255.0.0.0     |
| B         | 128.0.0.0 | 191.255.255.255 | 255.255.0.0   |
| C         | 192.0.0.0 | 223.255.255.255 | 255.255.255.0 |

ip地址是全球地址，识别局域网和主机通过ip分类实现的。

每个ip地址的32bit，分为两部分，部分1：区分局域网。部分2：区分主机

子网掩码告诉这两部分的分界。

A类ip 子网掩码 255.0.0.0换算成二进制，前8位是1，故前8位是部分1和后24位是部分2

依次类推 B类ip 前16位部分1，后16位部分2；C类ip 前24位部分1，后8位部分2；

### 网卡 路由器

ip地址识别的是网卡（NIC,network interface card）.网卡是硬件。一个电脑可以有多个网卡 以太网卡 wifi网卡。信息通过网卡进行流转。

路由器是配了多张网卡的机器

### Ip包接力

ip包传输需要经过路由器的接力。每一个主机和路由中都有一个路由表。路由表根据目的ip地址，规划ip包所走路线

例如：从主机145.22向146.21发送ip包。注明目的ip（199.165.146.21）和发出ip（199.165.145.22）。主机145.22才能做自己的roution table

| Destination   | Gateway        | Genmask       | Iface |
| ------------- | -------------- | ------------- | ----- |
| 199.165.145.0 | 0.0.0.0        | 255.255.255.0 | eth0  |
| 0.0.0.0       | 199.165.145.17 | 0.0.0.0       | eth0  |

第一行表示，如果ip的目的地址是199.165.145.0这个网络的主机，只需要自己在eth0上的网卡直接传送，不需要前往router(gateway 0.0.0.0)

第二行表示，所有不符合第一行的目的ip，都应送往gateway 199.165.145.17这个中间router ，接入在eth0的网卡ip地址（网卡实际是识别的是ip地址）

这里目的ip 199.165.146.21 不符合第一行，于是发送到199.165.145.17（ip数据包放在帧的 payload中，帧中有发送方的 mac地址）

中间router读取payload中的ip包数据，提取目的ip，对照自己的roution table

| Destination   | Gateway       | Genmask       | Iface |
| ------------- | ------------- | ------------- | ----- |
| 199.165.145.0 | 0.0.0.0       | 255.255.255.0 | eth0  |
| 199.165.146.0 | 0.0.0.0       | 255.255.255.0 | eth1  |
| 0.0.0.0       | 199.165.146.8 | 0.0.0.0       | eth1  |

前两行表示 rtouter横跨eth0和eth1两个网络。可直接通过eth0和eth1进行数据发送

第三行表示，不在前两行之内的ip，通过eth1送往 199.165.146.8

这个目标ip符合第二行，所以将ip包放入一个新的帧中，写明199.165.146.21的mac地址，直接发往146.21

linux下，可以使用$route -n 来查看routing table

![1561693820323](../image/1561693820323.png)

ip包通过中间router的接力，最终发到目标router,目标router和目标ip在同一个局域网内，可直接建立连接层的通信，在局域网的各个NIC(NIC, Network Interface Card)之间通信 。这样一个过程叫routing(路由)

整个过程伴随着帧的拆和封装（ip包）。利用ip包，无需关注底层链路层发生了什么

### ARP协议

局域网内每一台机器和路由都有 ip地址和mac地址的映射的关系。这个关系是通过arp协议传送到每台机器和路由。每台机器和路由都有arp cache,缓存对应关系

arp协议介于链路层和网络层之间。主机通过广播的形式发送arp包（包含自己的ip和mac地址），询问目地ip的mac地址，目的ip地址所在机器发现询问的ip属于自己的一个NIC,故进行mac地址回应（广播形式），其它机器接到路由会核实自己arp cache中的数据，不一致则更新。不断的经过这样的arp请求后，arp cache达到稳定。如果局域网设备发生变动，则重复以上过程

linux下可通过 arp命令查看arp过程。arp只用于ipv4.ipv6使用 Neighbor discovery protocol 来替换arp

### routing table

routing table描述了一种网络拓扑（topology）结构.一个路由器有很多个出口，如果周围路由器发生变动，需要及时更新自己的routing table 以便对ip数据包做正确的导向

rip（routing information protocol）协议，用来生成rounting table.是通过距离来决定routing table的。

所谓距离是指从出发地到目的地所途径的路由数量。如果途径两个路由，则距离记为2

路由a向自己周围的各个路由和主机以广播的方式发送rip包，包中记录这路由a到各个ip之间的距离。 接收方收到后 计算自己到各个ip之间的距离，如果计算的值大于（不等）参考路由a发出数据中计算出来的结果，则更新自己的routing table

例如：e a 到 b 到 c是 d      a 到e 是0 ，a到 b是1，如果b接到rip包后，计算b到e是3，则会更新自己的routing table

通过上述过程不断重复 rip 广播/计算距离/根据routing table，生成合理的路径

rip协议（技术原因）规定距离超过15的ip不可达。rip多用于互联网的一部分，一部分往往属于一个isp或一个管理机构，所以叫自治系统（autonomous system AS）

这样一个互联网的部分往往属于同一个ISP或者有同一个管理机构，所以叫做自治系统(AS,autonomous system)。

自治系统内部的主机和路由通过边界路由来和其它自治系统通信。边界路由通过bgp(border gateway protocol)生成前往其它AS的routing table.AS内部通过arp生成roution table

bgp除考虑距离外，还有政策 连接性等因素考虑







